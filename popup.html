<!--
This file is part of the tmac_chrome_extension.

tmac_chrome_extension is free software: you can redistribute it and/or modify
it under the terms of the GNU General Public License as published by
the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.

tmac_chrome_extension is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU General Public License for more details.

You should have received a copy of the GNU General Public License
along with tmac_chrome_extension.  If not, see <http://www.gnu.org/licenses/>.
-->

<style>
body {
	min-width: 200px;
	overflow-x: hidden;
}
</style>

<script>
function Beer() {
	this.name = "";        <!-- The name of the beer. -->
	this.container = { bottle: false, draught: false };   <!-- If it's in bottle or draught. -->
	this.style = "";       <!-- What type of beer (IPA, Dark, etc.) -->
	this.alcohol = "";     <!-- How drunk you get ;) -->
	this.description = ""; <!-- A description of the beer. -->
	this.brewery = "";     <!-- The name of the brewery. -->
	this.origin = "";      <!-- The place of origin. -->
	this.picture = "";     <!-- A url to a picture of the beer; may remove. -->
}

function findBeer(beer, beerList) {
	if (beerList[beer.name]) {
		return JSON.parse(beerList[beer.name]);
	}
	return null;
}

function addBeerToStorage(beer, beerList) {
	
	<!-- locate the current beer if it already exists. -->
	var existingBeer = beerList.list[beer.name];
	
	if (!existingBeer) {
		beerList.keys.push(beer.name);
		beerList.list[beer.name] = beer;
	} else if (existingBeer.container) {
		<!-- Update the available containers if new. -->
		if (beer.container.bottle) {
			existingBeer.container.bottle = beer.container.bottle;
		}
		if (beer.container.draught) {
			existingBeer.container.draught = beer.container.draught;
		}
		
		beerList.list[existingBeer.name] = existingBeer;
	}
}

function getBeerList() {
	if (!localStorage["beer_list"]) {
		return { list: {}, keys: [], drank_beers: 0, 
				 advancement: {
					 credits: [13, 75, 125, 175, 225, 275, 325, 425, 575, 750, 1000],
					 names: ["Pledge", "$10", "Bachelors", "$20", "Masters", 
							 "$30", "Ph.D", "$50", "Professor", "Dean", "Chancellor"]
				 }
		};
	}
	
	return JSON.parse(localStorage["beer_list"]);
}

function setBeerList(beerList) {
	localStorage["beer_list"] = JSON.stringify(beerList);	
}

function pull_beers() {
	console.log("logging...");
	
	chrome.tabs.executeScript(null, {file: 'beer_scraper.js'});
}

<!-- Add a listener for the scraper running in the page context. -->
chrome.extension.onRequest.addListener(function(beers, sender, sendResponse) {
	
	var storedList = getBeerList();
	var beerList = JSON.parse(beers);
	
	for (var i = 0; i < beerList.length; i++) {
		addBeerToStorage(beerList[i], storedList);
	}
	
	
	
	setBeerList(storedList);
	set_total();
	sendResponse({});
});

function set_total() {
	document.getElementById("total").innerText = getBeerList().keys.length;
}

<!-- Shows a tab with useful beer information. -->
function open_beer_tab() {
	chrome.tabs.create({url: "beer_list.html"});	
}
</script>

<html>
<head>

</head>

<body onLoad="javascript:set_total();">
<span id="total">loading...</span> in storage.<br/>
<a onClick="javascript:open_beer_tab();" href="#">View TMac Beers</a><br/>
<a id="pull_beers" onClick="javascript:pull_beers()" href="#">Pull TMac Beers</a>
</body>
</html>